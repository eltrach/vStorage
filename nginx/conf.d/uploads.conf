server {
  listen 80 default_server;

  # Read-only static root
  root /srv;

  # Block traversal
  location ~* \.\. { return 400; }

  # Lightweight health endpoint for container checks
  location = /healthz {
    access_log off;
    add_header Content-Type text/plain;
    return 200 'ok';
  }

  # Serve everything under /uploads/
  location ^~ /uploads/ {
    open_file_cache max=5000 inactive=60s;
    etag on;
    autoindex off;

    # Content types
    types {
      image/avif  avif;
      image/webp  webp;
      image/png   png;
      image/jpeg  jpg jpeg;
      image/svg+xml svg;
      image/gif   gif;
      audio/mpeg  mp3;
      video/mp4   mp4;
      application/json json;
      text/plain  txt;
      application/xml xml;
    }
    default_type application/octet-stream;

    # Harden inline-script capable formats
    location ~* \.svg$ {
      add_header Cache-Control "public, max-age=31536000, immutable" always;
      add_header Vary "Accept-Encoding" always;
      add_header Content-Security-Policy "default-src 'none'; style-src 'unsafe-inline'; img-src 'self' data:;" always;
      try_files $uri =404;
    }

    # 1-year cache for hashed filenames (your uploader should use content hashes)
    location ~* \.(avif|webp|png|jpe?g|gif|svg|mp4|mp3)$ {
      add_header Cache-Control "public, max-age=31536000, immutable" always;
      add_header Vary "Accept-Encoding" always;
      try_files $uri =404;
    }

    # Shorter cache for misc
    location ~* \.(json|txt|xml|map)$ {
      add_header Cache-Control "public, max-age=300" always;
      try_files $uri =404;
    }

    # Security headers
    add_header X-Content-Type-Options nosniff always;
    add_header Referrer-Policy no-referrer-when-downgrade always;
  }
}
